name: Test wf
on:
  pull_request:
    branches: ['main']
jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
      - name: First step
        run: |
          echo "[info] This is setup job."
          exit 0

  build:
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - name: Build
        run: |
          echo "[info] This is build job."
          exit 1

  result:
    if: always()
    needs: [setup, build]
    runs-on: ubuntu-latest
    steps:
      - name: Wait step
        run: |
          echo "[info] This is build job."
          sleep 30
          exit 0

      - name: Check job results
        run: |
          echo '${{ toJSON(needs) }}' | jq 'to_entries | map(.key + " " + .value.result) | join(" - ")'
          if [ ${{ needs.setup.result}} != 'success' ]; then
            echo "[info] Setup job is not success."
            exit 1
          fi
          if [ ${{ needs.build.result}} != 'success' ]; then
            echo "[info] Build job is not success."
            exit 1
          fi
          echo "[info] All jobs success."
